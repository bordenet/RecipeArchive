# Unified Recipe Data Model Specification

**See also:** [Website Parsers Architecture Decision Record](./website-parsers.md)

## Document Status: **DRAFT - PENDING APPROVAL**

**Date**: August 24, 2025  
**Authority**: Master specification for all RecipeArchive platforms

## Problem Statement

The current PRDs define recipe data inconsistently:

- **Browser Extension PRD**: 8 specific fields detailed
- **iOS App PRD**: Vague "all recipe fields"
- **Website PRD**: Vague "all recipe fields"
- **AWS Backend PRD**: Incomplete field list, missing recipe title

This creates implementation ambiguity and potential data incompatibility across platforms.

## Unified Recipe Data Model

### Core Recipe Entity

```typescript
interface Recipe {
  // Primary Identifiers
  id: string; // UUID v4, generated by backend
  userId: string; // AWS Cognito user ID

  // Required Fields (Browser Extension Extraction)
  title: string; // Recipe name (max 200 chars)
  ingredients: Ingredient[]; // Structured ingredient list
  instructions: Instruction[]; // Step-by-step cooking directions
  sourceUrl: string; // Original recipe URL
  mainPhotoUrl?: string; // Hero image URL (S3 signed URL)

  // Optional Metadata (If Available)
  prepTimeMinutes?: number; // Preparation time
  cookTimeMinutes?: number; // Cooking time
  totalTimeMinutes?: number; // Total time (prep + cook)
  servings?: number; // Number of servings
  yield?: string; // Alternative to servings (e.g., "24 cookies")

  // System Fields
  createdAt: string; // ISO 8601 timestamp
  updatedAt: string; // ISO 8601 timestamp
  isDeleted: boolean; // Soft delete flag
  version: number; // For conflict resolution

  // Archive & Backup
  webArchiveUrl?: string; // Full page backup (S3 signed URL)
  webArchiveFormat: 'html' | 'pdf'; // Archive format

  // Future Extensions (Optional)
  tags?: string[]; // User-defined tags
  notes?: string; // User notes
  rating?: number; // User rating (1-5)
}

interface Ingredient {
  quantity?: number; // Numeric amount (e.g., 2)
  unit?: string; // Unit of measurement (e.g., "cups")
  name: string; // Ingredient name (e.g., "all-purpose flour")
  notes?: string; // Additional info (e.g., "sifted", "room temperature")
  originalText: string; // Original extracted text for fallback
}

interface Instruction {
  stepNumber: number; // Sequential step number (1, 2, 3...)
  text: string; // Instruction text
  timeMinutes?: number; // Time for this step (if specified)
  temperature?: string; // Temperature (e.g., "350°F", "medium heat")
}
```

### Validation Rules

#### Required Field Validation

- `title`: 1-200 characters, no special formatting
- `ingredients`: Minimum 1 ingredient with valid `name`
- `instructions`: Minimum 1 instruction with valid `text`
- `sourceUrl`: Valid HTTP/HTTPS URL
- `userId`: Valid AWS Cognito user ID format

#### Optional Field Validation

- `prepTimeMinutes`, `cookTimeMinutes`, `totalTimeMinutes`: 0-1440 (24 hours max)
- `servings`: 1-100
- `mainPhotoUrl`, `webArchiveUrl`: Valid S3 URLs with proper signatures
- `tags`: Maximum 10 tags, 50 characters each
- `notes`: Maximum 2000 characters

#### Data Integrity Rules

- `totalTimeMinutes` should equal `prepTimeMinutes + cookTimeMinutes` when all are present
- `ingredients[].stepNumber` must be sequential starting from 1
- `instructions[].stepNumber` must be sequential starting from 1
- URLs must be from allowed domains or S3 buckets

### Platform-Specific Handling

#### Browser Extension

- **Extraction Priority**: Always attempt to extract all core fields
- **Fallback Strategy**: If structured extraction fails, store in `originalText` fields
- **Photo Handling**: Download and upload to S3 during extraction
- **Archive Creation**: Always create HTML backup, PDF as fallback

#### iOS App / Website

- **Display Format**: Render ingredients and instructions in clean, readable format
- **Editing Support**: Allow modification of all fields except `id`, `userId`, system fields
- **Photo Management**: Support photo upload/replacement with S3 integration
- **Offline Storage**: Cache full recipe objects locally

#### AWS Backend

- **Storage**: Recipe metadata in DynamoDB, photos/archives in S3
- **API Format**: Return all fields in JSON format with S3 signed URLs
- **Search Indexing**: Index `title`, `ingredients[].name`, `tags` for search functionality
- **Versioning**: Increment `version` on every update for sync conflict resolution

### Database Schema (DynamoDB)

#### Primary Table: `recipes`

- **Partition Key**: `userId` (String)
- **Sort Key**: `id` (String)
- **Attributes**: All Recipe fields except URLs (computed at runtime)

#### Global Secondary Index: `recipes-by-created`

- **Partition Key**: `userId` (String)
- **Sort Key**: `createdAt` (String)
- **Purpose**: Chronological listing

#### Global Secondary Index: `recipes-by-title`

- **Partition Key**: `userId` (String)
- **Sort Key**: `title` (String)
- **Purpose**: Alphabetical listing and title search

### S3 Storage Structure

```
recipeArchive-{environment}/
├── users/
│   └── {userId}/
│       ├── photos/
│       │   └── {recipeId}/
│       │       ├── main.jpg        # Main recipe photo
│       │       └── step-{n}.jpg    # Future: step photos
│       └── archives/
│           └── {recipeId}/
│               ├── page.html       # Full page backup
│               └── page.pdf        # PDF fallback
```

### API Response Format

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "userId": "us-west-2:12345678-1234-1234-1234-123456789012",
  "title": "Perfect Chocolate Chip Cookies",
  "ingredients": [
    {
      "quantity": 2.25,
      "unit": "cups",
      "name": "all-purpose flour",
      "originalText": "2¼ cups all-purpose flour"
    }
  ],
  "instructions": [
    {
      "stepNumber": 1,
      "text": "Preheat oven to 375°F (190°C).",
      "temperature": "375°F"
    }
  ],
  "sourceUrl": "https://smittenkitchen.com/2022/01/perfect-chocolate-chip-cookies",
  "mainPhotoUrl": "https://s3.amazonaws.com/recipeArchive-prod/users/abc123/photos/recipe456/main.jpg?signed=...",
  "prepTimeMinutes": 15,
  "cookTimeMinutes": 12,
  "totalTimeMinutes": 27,
  "servings": 24,
  "createdAt": "2025-08-24T10:30:00Z",
  "updatedAt": "2025-08-24T10:30:00Z",
  "isDeleted": false,
  "version": 1,
  "webArchiveUrl": "https://s3.amazonaws.com/recipeArchive-prod/users/abc123/archives/recipe456/page.html?signed=...",
  "webArchiveFormat": "html"
}
```

## Migration Impact on PRDs

### Required PRD Updates

#### Browser Extension PRD

- ✅ Recipe data fields already match this specification
- **Add**: Ingredient and Instruction structured format details
- **Add**: Validation rules for extracted data

#### iOS App PRD

- **Replace**: "all recipe fields" with specific field list from this spec
- **Add**: Local storage schema requirements
- **Add**: Conflict resolution strategy (version-based)

#### Website PRD

- **Replace**: "all recipe fields" with specific field list from this spec
- **Add**: Form validation requirements
- **Add**: S3 photo upload specifications

#### AWS Backend PRD

- **Replace**: Incomplete field list with complete Recipe interface
- **Add**: DynamoDB schema specification
- **Add**: S3 bucket structure requirements
- **Add**: API response format specification

## Implementation Priority

### Phase 1: Core Fields (Week 1)

- `id`, `userId`, `title`, `ingredients`, `instructions`, `sourceUrl`
- Basic DynamoDB schema
- Simple API endpoints

### Phase 2: Metadata (Week 2)

- Time fields, servings, photos
- S3 integration
- Enhanced validation

### Phase 3: Archives & Search (Week 3)

- Web archive storage
- Search indexing
- Advanced querying

### Phase 4: Extensions (Week 4)

- Tags, notes, ratings
- Conflict resolution
- Performance optimization

---

**Next Steps**:

1. Get approval for this unified data model
2. Update all four PRDs with consistent field specifications
3. Begin DynamoDB table design
4. Create API endpoint specifications

**Approval Required By**: August 25, 2025
