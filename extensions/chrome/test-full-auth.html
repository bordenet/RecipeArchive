<!DOCTYPE html>
<html>
<head>
    <title>Full Chrome Extension Auth Test</title>
    <script src="config.js"></script>
    <script src="cognito-auth.js"></script>
</head>
<body>
    <h2>Full Chrome Extension Authentication Test</h2>
    <div id="status">Loading...</div>
    <button id="setupConfig">1. Setup Configuration</button>
    <button id="testAuth">2. Test Authentication</button>
    <div id="results"></div>

    <script>
        function log(message) {
            const results = document.getElementById('results');
            results.innerHTML += '<div>' + new Date().toLocaleTimeString() + ': ' + message + '</div>';
            console.log(message);
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // Setup configuration like the extension popup does
        document.getElementById('setupConfig').addEventListener('click', function() {
            try {
                log('Setting up localStorage configuration...');
                
                // Set the same values that popup.js would set
                localStorage.setItem('COGNITO_USER_POOL_ID', 'us-west-2_qJ1i9RhxD');
                localStorage.setItem('COGNITO_APP_CLIENT_ID', '6nt4hv92d22gp9u2l1vhqks1o1');  
                localStorage.setItem('AWS_REGION', 'us-west-2');
                localStorage.setItem('API_BASE_URL', 'https://4sgexl03l7.execute-api.us-west-2.amazonaws.com');
                
                log('LocalStorage values set');
                
                // Reload configuration like popup.js does
                if (typeof CONFIG !== 'undefined' && CONFIG.reloadConfiguration) {
                    CONFIG.reloadConfiguration();
                    log('Configuration reloaded');
                } else {
                    log('WARNING: CONFIG.reloadConfiguration not available');
                }
                
                // Verify new config
                const cognitoConfig = CONFIG.getCognitoConfig();
                log('New Cognito UserPoolId: ' + cognitoConfig.userPoolId);
                log('New Cognito ClientId: ' + cognitoConfig.clientId);
                
                updateStatus('Configuration setup completed');
                
            } catch (error) {
                log('Configuration setup error: ' + error.message);
                updateStatus('Configuration setup failed');
            }
        });

        // Test authentication instantiation
        document.getElementById('testAuth').addEventListener('click', function() {
            try {
                log('Testing ChromeCognitoAuth with real configuration...');
                
                const cognitoConfig = CONFIG.getCognitoConfig();
                log('Using UserPoolId: ' + cognitoConfig.userPoolId);
                log('Using ClientId: ' + cognitoConfig.clientId);
                log('Using Region: ' + cognitoConfig.region);
                
                if (cognitoConfig.userPoolId === 'CONFIGURE_ME') {
                    log('ERROR: Configuration not properly loaded - still showing CONFIGURE_ME');
                    updateStatus('Configuration not loaded');
                    return;
                }
                
                const auth = new ChromeCognitoAuth({
                    region: cognitoConfig.region,
                    userPoolId: cognitoConfig.userPoolId,
                    clientId: cognitoConfig.clientId
                });
                
                log('ChromeCognitoAuth instance created with real AWS config');
                log('Auth instance methods: ' + Object.getOwnPropertyNames(Object.getPrototypeOf(auth)));
                
                // Test that we can call methods without the abstract method error
                try {
                    // This should not throw "_setStoredItem must be implemented by subclass"
                    auth._setStoredItem('test-key', 'test-value');
                    log('SUCCESS: _setStoredItem method works (no abstract method error)');
                    
                    const testValue = auth._getStoredItem('test-key');
                    log('Retrieved test value: ' + testValue);
                } catch (methodError) {
                    log('ERROR: Method test failed: ' + methodError.message);
                }
                
                updateStatus('Authentication test completed successfully');
                
            } catch (error) {
                log('Authentication test error: ' + error.message);
                log('Error stack: ' + error.stack);
                updateStatus('Authentication test failed');
            }
        });

        // Auto-run setup on load
        setTimeout(function() {
            document.getElementById('setupConfig').click();
        }, 100);
    </script>
</body>
</html>